name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: "3.10"
      - name: Fetch pip cache
        uses: actions/cache@v2
        with:
          path: ~/.cache/pip
          key: pip
      - name: Install dependencies
        run: |
          pip install pylint~=2.0
      - name: Analyzing the code
        run: |
          pylint secured_fields test_secured_fields
  test-pg:
    needs:
      - lint
    runs-on: ubuntu-latest
    strategy:
      matrix:
        postgres: [ "12.9", "13.5", "14.1" ]
    services:
      postgres:
        image: postgres:${{ matrix.postgres }}-alpine
        env:
          POSTGRES_DB: db
          POSTGRES_PASSWORD: P@ssw0rd
        ports:
          - 5432/tcp
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: ./.github/workflows/shared/test.yaml
        with:
          database-url: "postgresql://postgres:P%40ssw0rd@localhost:${{ job.services.postgres.ports[5432] }}/db"
  test-mysql:
    needs:
      - lint
    runs-on: ubuntu-latest
    strategy:
      matrix:
        mysql: [ "5.7", "8.0" ]
    services:
      mysql:
        image: mysql:${{ matrix.mysql }}
        env:
          MYSQL_DATABASE: db
          MYSQL_ROOT_PASSWORD: P@ssw0rd
        ports:
          - 3306/tcp
        options: >-
          --health-cmd "mysqladmin ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: ./.github/workflows/shared/test.yaml
        with:
          database-url: "mysql://root:P%40ssw0rd@localhost:${{ job.services.mysql.ports[3306] }}/db"
